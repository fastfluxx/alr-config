proxy_cache_path /var/cache/nginx keys_zone=my_cache:100m levels=1:2 inactive=10d use_temp_path=off max_size=65g;

server {
    listen 443 ssl;
    server_name contentcache.example.com;

    # Use the same certificate as your cloud server, or a LAN-issued cert
    ssl_certificate /home/user/certs/cert.crt;
    ssl_certificate_key /home/user/certs/cert.key;

    # Recommended SSL security settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
	resolver_timeout 5s;
	resolver 1.1.1.1 ipv6=off;
	set $source_url "https://contentcache.example.com";
	proxy_pass $source_url;
	#proxy_pass https://contentcache.laud-media.com;
        proxy_ssl_server_name on;
        proxy_set_header Host contentcache.example.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

	proxy_cache_key "$scheme$request_method$host$request_uri";
	proxy_cache_lock on;
	proxy_cache_lock_timeout 20s;



	# Combine all conditions into one line
	proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

	# Enable the proactive background refresh
	proxy_cache_background_update on;

	proxy_hide_header Cache-Control;
	proxy_hide_header Expires;

	proxy_buffers 1024 4k;
	proxy_buffer_size 128k;
	proxy_busy_buffers_size 256k;


	# Performance tuning
	proxy_buffering on;
	proxy_max_temp_file_size 0;
	sendfile on;
	tcp_nopush on;
	aio threads;

        # Enable caching
        proxy_cache my_cache;
        proxy_cache_valid 200 302 7d;
        proxy_cache_valid 404 5m;
	proxy_ignore_headers Cache-Control Expires;
        add_header X-Proxy-Cache $upstream_cache_status;
    }

}

